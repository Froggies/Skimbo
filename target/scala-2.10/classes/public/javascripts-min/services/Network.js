define(["app"],function(e){return e.factory("Network",["$http","$timeout","ServerCommunication","$location","$window",function(e,t,n,r,i){function m(){c==undefined&&(c=new WebSocket(u),c.onclose=function(){c=undefined,p++,t(function(){v==1&&p<d?m():(p=0,g())},500),console.log("WS closed : nbError = ",p)},c.onerror=function(){c=undefined,p++,t(function(){v==1&&p<d?m():(p=0,g())},800),console.log("WS error : nbError = ",p)},c.onmessage=function(e){v=!0,p=0;var t;try{t=JSON.parse(e.data)}catch(n){t=e.data}b(t)},t(function(){v==0&&h==undefined&&(console.log("no data after 5sc !"),c=undefined,p=0,g())},5e3))}function g(){console.log("sseMode actif !"),h==undefined&&(h=new EventSource(a),h.addEventListener("message",function(e){p=0;var t;try{t=JSON.parse(e.data)}catch(n){t=e.data}b(t)},!1),h.addEventListener("error",function(e){h.close(),h=undefined,p++,t(function(){p<d?g():n.cmd({cmd:"disconnect"})},800),console.log("sse error : nb = ",p)},!1))}function y(){console.log("longPollingMode actif !");var e=document.createElement("iframe");e.hidden=!0,e.src=l,window.longPolling=function(e){var t;try{t=JSON.parse(e)}catch(n){t=e}b(t)},console.log(angular.element(i)),t(function(){document.body.appendChild(e)},3500)}function b(e){e.cmd=="ping"?w({cmd:"pong"}):n.cmd(e)}function w(t){c!==undefined?c.send(JSON.stringify(t)):e.post("/api/stream/command",JSON.stringify(t))}var s=r.$$protocol==="https",o=r.path().split("/"),u=jsRoutes.controllers.stream.WebSocket.connect().webSocketURL(s);o!==undefined&&o.length==3&&(u=u+"/"+o[2]),console.log("WHOST URL = "+u);var a=jsRoutes.controllers.stream.Sse.connect().absoluteURL(s);console.log("SSEHOST URL = "+a);var f=jsRoutes.controllers.stream.Sse.ping().absoluteURL(s);console.log("SSEPING URL = "+f);var l=jsRoutes.controllers.stream.LongPolling.connect().absoluteURL(s);console.log("LONGPOLLING URL = "+l);var c=undefined,h=undefined,p=0,d=5,v=!1;return console.log("ws supported","WebSocket"in window),console.log("sse supported","EventSource"in window),window.MozWebSocket&&(window.WebSocket=window.MozWebSocket),!window.WebSocket&&!window.EventSource?y():window.WebSocket?m():g(),{send:function(e){w(e)}}}]),e})