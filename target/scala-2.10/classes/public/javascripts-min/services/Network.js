define(["app"],function(e){return e.factory("Network",["$http","$timeout","ServerCommunication","$location",function(e,t,n,r){function d(){f==undefined&&(f=new WebSocket(o),f.onclose=function(){f=undefined,c++,t(function(){p==1&&c<h?d():(c=0,v())},500),console.log("WS closed : nbError = ",c)},f.onerror=function(){f=undefined,c++,t(function(){p==1&&c<h?d():(c=0,v())},800),console.log("WS error : nbError = ",c)},f.onmessage=function(e){p=!0,c=0;var t;try{t=JSON.parse(e.data)}catch(n){t=e.data}m(t)},t(function(){p==0&&l==undefined&&(console.log("no data after 5sc !"),f=undefined,c=0,v())},5e3))}function v(){console.log("sseMode actif !"),l==undefined&&(l=new EventSource(u),l.addEventListener("message",function(e){c=0;var t;try{t=JSON.parse(e.data)}catch(n){t=e.data}m(t)},!1),l.addEventListener("error",function(e){l.close(),l=undefined,c++,t(function(){c<h?v():n.cmd({cmd:"disconnect"})},800),console.log("sse error : nb = ",c)},!1))}function m(e){e.cmd=="ping"?g({cmd:"pong"}):n.cmd(e)}function g(t){f!==undefined?f.send(JSON.stringify(t)):e.post("/api/stream/command",JSON.stringify(t))}var i=r.$$protocol==="https",s=r.path().split("/"),o=jsRoutes.controllers.stream.WebSocket.connect().webSocketURL(i);s!==undefined&&s.length==3&&(o=o+"/"+s[2]),console.log("WHOST URL = "+o);var u=jsRoutes.controllers.stream.Sse.connect().absoluteURL(i);console.log("SSEHOST URL = "+u);var a=jsRoutes.controllers.stream.Sse.ping().absoluteURL(i);console.log("SSEPING URL = "+a);var f=undefined,l=undefined,c=0,h=5,p=!1;return window.MozWebSocket&&(window.WebSocket=window.MozWebSocket),window.WebSocket?d():v(),{send:function(e){g(e)}}}]),e})