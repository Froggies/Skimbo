define(["app"],function(e){return e.controller("ModifColumnController",["$scope","Network","$rootScope","UnifiedRequestUtils","Visibility","PopupProvider","ArrayUtils","$http",function(e,t,n,r,i,s,o,u){function a(t){console.log(t),t.fromServer=!1,e.column.unifiedRequests.push(JSON.parse(JSON.stringify(t))),e.column.title==""&&(e.column.title=t.providerName+" "+t.serviceName)}function f(){e.availableSocialNetworksWidth="90%",e.selectedSocialNetwork!=undefined&&(e.selectedSocialNetwork.selected=!1),e.selectedSocialNetwork=undefined,e.showErrorBlankArg=!1,e.showErrorDoubleParser=!1,e.showErrorTitleRequired=!1,e.showErrorTitleAlreadyExist=!1;if(e.column!==undefined){e.column.title=e.column.oldTitle;for(var t=e.column.unifiedRequests.length-1;t>=0;t--)e.column.unifiedRequests[t].fromServer==0&&e.column.unifiedRequests.splice(t,1)}e.column=undefined}function c(e){for(var t=0;t<e.unifiedRequests.length;t++)for(var n=0;n<e.unifiedRequests[t].args.length;n++){e.unifiedRequests[t].args[n].value=e.unifiedRequests[t].args[n].value.replace(l,"");if(e.unifiedRequests[t].args[n].value=="")return!0}return!1}function h(e){var t=0,n=0;for(var r=0;r<e.unifiedRequests.length;r++){t=0,n=0;for(var i=0;i<e.unifiedRequests.length;i++)if(e.unifiedRequests[r].args.length>0)for(var s=0;s<e.unifiedRequests[r].args.length;s++){for(var o=0;o<e.unifiedRequests[i].args.length;o++)e.unifiedRequests[r].service==e.unifiedRequests[i].service&&e.unifiedRequests[r].args[s].value==e.unifiedRequests[i].args[o].value&&n++;if(n>1)return!0}else e.unifiedRequests[r].service==e.unifiedRequests[i].service&&t++;if(t>1)return!0}return!1}function p(e){return e.title==""}function d(t){var n=0;for(var r=0;r<e.columnsTitle.length;r++)if(e.columnsTitle[r]==t.title){n++;if(t.newColumn==0&&n>1)return!0;if(t.newColumn==1)return!0}return!1}function v(){e.providers.push({endpoint:"greader",hasToken:!0,name:"greader",selected:!1,services:[]})}function m(){console.log("show"),e.googleReaderSelected=!0}e.$destroy=function(){var e=this.$parent;this.$broadcast("$destroy"),e.$$childHead==this&&(e.$$childHead=this.$$nextSibling),e.$$childTail==this&&(e.$$childTail=this.$$prevSibling),this.$$prevSibling&&(this.$$prevSibling.$$nextSibling=this.$$nextSibling),this.$$nextSibling&&(this.$$nextSibling.$$prevSibling=this.$$prevSibling),this.$id=null,this.$$phase=this.$parent=this.$$watchers=this.$$nextSibling=this.$$prevSibling=this.$$childHead=this.$$childTail=null,this["this"]=this.$root=null,this.$$asyncQueue=null,this.$$listeners=null},e.showModifyColumn=!1,e.availableSocialNetworksWidth="90%",e.column=undefined,e.selectedSocialNetwork=undefined,e.providers=undefined,e.columnsTitle=[],n.$on("allColumns",function(t,n){e.$apply(function(){for(var t=0;t<n.length;t++)e.columnsTitle.push(new String(n[t].title))})}),n.$on("allUnifiedRequests",function(t,n){e.$apply(function(){e.providers=n;for(var t=0;t<n.length;t++){var i=n[t];i.selected=!1,i.name=i.endpoint;for(var s=0;s<i.services.length;s++){var o=i.services[s],u=r.serverToUnifiedRequest(o);i.services[s]=u}e.selectedSocialNetwork!=undefined&&e.selectedSocialNetwork.name==i.name&&(e.selectedSocialNetwork=i,e.selectedSocialNetwork.selected=!0)}v()})}),n.$on("clientModifyColumn",function(t,n){e.show(JSON.parse(JSON.stringify(n)))}),n.$on("addColumn",function(t,n){e.columnsTitle.push(new String(n.title))}),n.$on("modColumn",function(t,n){e.$apply(function(){for(var t=0;t<e.columnsTitle.length;t++)if(e.columnsTitle[t]==n.title){e.columnsTitle.splice(t,1),e.columnsTitle.push(new String(n.column.title));break}})}),e.show=function(n){f(),e.showModifyColumn=!e.showModifyColumn,e.showModifyColumn==1&&(e.providers==undefined&&t.send({cmd:"allUnifiedRequests"}),n!==undefined?(e.column=n,e.column.newColumn=!1,e.column.oldTitle=e.column.title):(e.column={},e.column.newColumn=!0,e.column.title="",e.column.unifiedRequests=[]))},e.selectSocialNetwork=function(t){e.selectedSocialNetwork!=undefined&&(e.selectedSocialNetwork.selected=!1),e.selectedSocialNetwork=t,e.selectedSocialNetwork.selected=!0,e.availableSocialNetworksWidth="",t.name=="greader"?m():e.googleReaderSelected=!1},e.addService=function(n){n.hasParser==1&&(e.selectedSocialNetwork.hasToken==1?a(n):s.openPopup(e.selectedSocialNetwork,function(){a(n),t.send({cmd:"allUnifiedRequests"}),t.send({cmd:"allPosters"})}))},e.selectOracle=function(e,t){e.possibleValues=[],e.value=t.call},e.cancelCreateColumn=function(){f(),e.showModifyColumn=!1},e.deleteService=function(t,n){var r=!1;for(var i=0;!r&&i<e.column.unifiedRequests.length;i++)if(e.column.unifiedRequests[i].service==t.service&&e.column.unifiedRequests[i].args.length>0)for(var s=0;!r&&s<e.column.unifiedRequests[i].args.length;s++){var o=e.column.unifiedRequests[i].args[s];n.key==o.key&&n.value==o.value&&(r=!0,e.column.unifiedRequests.splice(i,1))}else e.column.unifiedRequests[i].service==t.service&&n===undefined&&(r=!0,e.column.unifiedRequests.splice(i,1))},e.validate=function(){var n="",i=[],s=e.column;for(var o=0;o<s.unifiedRequests.length;o++)i.push(r.clientToServerUnifiedRequest(s.unifiedRequests[o]));s.newColumn==0?n={cmd:"modColumn",body:{title:s.oldTitle,column:{title:s.title,unifiedRequests:i,index:s.index,width:s.width,height:s.height}}}:n={cmd:"addColumn",body:{title:s.title,unifiedRequests:i,index:e.columnsTitle.length,width:-1,height:-1}},e.showErrorBlankArg=c(s),e.showErrorDoubleParser=h(s),e.showErrorTitleRequired=p(s),e.showErrorTitleAlreadyExist=d(s),e.showErrorBlankArg==0&&e.showErrorDoubleParser==0&&e.showErrorTitleRequired==0&&e.showErrorTitleAlreadyExist==0&&(e.showModifyColumn=!e.showModifyColumn,t.send(n))},e.deleteColumn=function(){t.send({cmd:"delColumn",body:{title:e.column.oldTitle}}),e.showModifyColumn=!1};var l=/[&\\#,+()$~%'":*?<>{}]/g;e.googleReaderSelected=!1,e.googleReaderFeeds="",e.parseGoogleReader=function(){console.log("parse");var t=JSON.parse(e.googleReaderFeeds).subscriptions;for(var n=0;n<t.length;n++){var r=t[n].id.substring(5,t[n].id.length);a({fromServer:!1,hasArguments:!0,hasParser:!0,providerName:"rss",service:"rss.rss",serviceName:"rss",args:[{key:"url",value:r}]})}}}]),e})